#!/bin/bash

BMT_NO=`basename $0`
LOGDIR=../log
mkdir -p $LOGDIR

LOGFILE=$LOGDIR"/"$BMT_NO".log"

START_TM1=`date "+%Y-%m-%d %H:%M:%S"`

###### query start
psql -U udba  -e >> $LOGFILE 2>&1 <<-!
\o /dev/null

select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '67753','91863','85160','37667','70970','12286',
                          '81815','79918','53422','41571','90534',
                          '77497','74813','69657','60506','90635',
                          '30141','24128','29242','16814','73408',
                          '27777','85692','94289','79278','23966',
                          '14993','80895','24534','73294','92029',
                          '18323','83406','19513','31104','48294',
                          '28350','15273','46192','82208','21154',
                          '46285','75590','79412','61839','34179',
                          '97366','94415','99062','45087','97195',
                          '25114','61796','78565','15026','90572',
                          '20347','59690','60897','15020','42601',
                          '46028','96935','13813','36457','72365',
                          '30839','10882','63417','48826','67518',
                          '65272','35788','82805','95000','52926',
                          '25738','50705','47281','65882','64938',
                          '34216','21886','62177','54860','46418',
                          '88806','18489','57997','54697','26105',
                          '47532','27302','56171','84949','40994',
                          '70597','21428','38818','88396','58092',
                          '21806','23179','20873','62872','88405',
                          '92704','65548','44005','92553','27537',
                          '42699','49012','79114','87215','21149',
                          '68519','39592','56842','93320','23265',
                          '45559','35797','65998','43555','47138',
                          '42172','37566','67959','82455','14468',
                          '18693','19128','12165','21591','19635',
                          '43190','42085','36930','65082','78735',
                          '19676','38434','90416','30348','43317',
                          '20786','49642','39622','18864','26493',
                          '75554','18428','65074','51151','86854',
                          '85499','12911','83896','45342','67321',
                          '32922','84971','34003','92864','91053',
                          '54846','33841','50201','91606','96032',
                          '53155','16343','61006','51397','10894',
                          '44452','29916','82764','17010','42571',
                          '49169','18052','56410','25996','68051',
                          '57589','16117','30065','13815','51285',
                          '35170','45202','33227','40317','46257',
                          '56290','81949','20127','35538','29174',
                          '35093','72073','25377','63924','42063',
                          '59740','10314','55641','41069','60569',
                          '38508','46452','58077','54667','30772',
                          '36033','62067','21396','21047','34093',
                          '56478','30246','82858','33938','93476',
                          '47495','31330','68788','85918','33358',
                          '37176','33383','80205','59858','23994',
                          '74096','31726','92746','52415','97618',
                          '84284','48695','66105','31841','85508',
                          '12149','54281','35703','35252','21993',
                          '58289','38802','77785','13071','45392',
                          '55821','21947','42380','98419','82846',
                          '41328','46184','24895','83209','33014',
                          '56228','53431','78778','54416','59689',
                          '23961','11427','87947','79120','51361',
                          '61346','81980','22380','83316','53177',
                          '10842','25691','14823','25074','22268',
                          '42204','15296','94156','87492','28202',
                          '29133','35392','46690','65073','97759',
                          '60031','92052','52252','45264','13587',
                          '41259','18546','34073','43130','46875',
                          '31090','40597','57527','10105','20270',
                          '33290','23770','13598','36517','11912',
                          '68681','78360','66283','40543','42292',
                          '25971','95659','91857','63104','43072',
                          '14714','28744','56579','39793','16810',
                          '48027','16457','99303','13255','71086',
                          '95827','22907','47775','45204','51767',
                          '48059','60164','54859','13939','16253',
                          '91896','18053','93388','57385','87547',
                          '30405','78448','63009','43465','15110',
                          '27724','79923','47231','30900','31073',
                          '82173','57375','86009','94270','12619',
                          '61948','43215','17116','85569','65851',
                          '66114','99942','77943','87401','72239',
                          '24807','42876','57011','74975','32745',
                          '51235','42666','56762','71998','48000',
                          '90580','46622','34799','18011','73386',
                          '26202','56248','62349','16357','27570',
                          '91582','72213','38839','42307')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

!
###### query end

END_TM1=`date "+%Y-%m-%d %H:%M:%S"`




SEC1=`date +%s -d "${START_TM1}"`
SEC2=`date +%s -d "${END_TM1}"`
DIFFSEC=`expr ${SEC2} - ${SEC1}`

echo $BMT_NO"|"$START_TM1"|"$END_TM1"|"$DIFFSEC  >> $LOGFILE

